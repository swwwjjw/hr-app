<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js@1.2.2/src/wordcloud2.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    h1 { margin: 0 0 12px; }
    .meta { color: #6b7280; margin-bottom: 16px; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    .controls { margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    input, button, select { padding: 8px 10px; }
  </style>
  </head>
<body>
  <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π</h1>
  <div class="meta" style="margin-bottom: 16px; color: #000000; font-weight: bold;">üìç –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</div>
  <div id="vacancyStats" class="meta" style="margin-bottom: 16px; color: #000000; font-weight: bold; font-size: 14px;"></div>
  <div class="controls">
    <input id="q" placeholder="query (e.g. python developer)" style="display: none;" />
    <select id="presets">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é</option>
      <option value="–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –∫–ø–ø">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã-–∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä—ã</option>
      <option value="–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –¥–æ—Å–º–æ—Ç—Ä">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –ø–æ –¥–æ—Å–º–æ—Ç—Ä—É</option>
      <option value="–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –ø–µ—Ä—Ä–æ–Ω">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –ø–µ—Ä—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è</option>
      <option value="–≥–±—Ä, –æ—Ö—Ä–∞–Ω–∞">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä –ì–ë–†</option>
    </select>
    <button id="apply">–ù–∞–π—Ç–∏</button>
    <div id="stackedPicker" style="display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin-left: 12px;">
      <span style="font-weight: 600;">–í—ã–±–æ—Ä –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã:</span>
      <label><input type="checkbox" class="vacancyChoice" value="–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –∫–ø–ø" checked /> –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã-–∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä—ã</label>
      <label><input type="checkbox" class="vacancyChoice" value="–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –¥–æ—Å–º–æ—Ç—Ä" checked /> –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –ø–æ –¥–æ—Å–º–æ—Ç—Ä—É</label>
      <label><input type="checkbox" class="vacancyChoice" value="–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –ø–µ—Ä—Ä–æ–Ω" checked /> –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –ø–µ—Ä—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è</label>
      <label><input type="checkbox" class="vacancyChoice" value="–≥–±—Ä, –æ—Ö—Ä–∞–Ω–∞" checked /> –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä –ì–ë–†</label>
      <button id="applyStacked">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É</button>
    </div>
  </div>
  <div class="card" id="marketCard" style="margin-top:24px; padding:20px;">
    <h3>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º</h3>
    <div style="display:flex; justify-content:space-between; font-size:12px; color:#6b7280; margin-bottom:12px;">
      <div>–ù–∏–∂–µ —Ä—ã–Ω–∫–∞</div>
      <div>–í —Ä—ã–Ω–∫–µ</div>
      <div>–í—ã—à–µ —Ä—ã–Ω–∫–∞</div>
    </div>
    <div id="marketScale" style="position:relative; height:48px; border-radius:24px; background:#f9fafb;
      overflow:visible; margin-bottom:16px;">
      <div id="bandBelow" style="position:absolute; left:0; top:0; bottom:0; background:#fee2e2;"></div>
      <div id="bandIn" style="position:absolute; top:0; bottom:0; background:#dcfce7;"></div>
      <div id="bandAbove" style="position:absolute; top:0; bottom:0; background:#dbeafe;"></div>
             <div id="markerPulkovoLine" title="–ü—É–ª–∫–æ–≤–æ –∑–∞—Ä–ø–ª–∞—Ç–∞" style="position:absolute; top:0; bottom:0; width:3px; background:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.20);"></div>
      <div id="markerPulkovoLabel" style="position:absolute; top:52px; transform:translateX(-50%); color:#3b82f6; font-weight:700; font-size:12px; white-space:nowrap;"></div>
    </div>
    <div id="marketTicks" style="display:flex; justify-content:space-between; font-size:14px; font-weight:500;">
      <div id="valP25" style="color:#ef4444;">‚Äì</div>
      <div id="valP50" style="color:#22c55e;">‚Äì</div>
      <div id="valP75" style="color:#22c55e;">‚Äì</div>
      <div id="valMax" style="color:#60a5fa;">‚Äì</div>
    </div>
  </div>
  <div class="row">
    <div class="card">
      <h3>–ó–∞—Ä–ø–ª–∞—Ç–∞ vs –†–µ–π—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è</h3>
      <canvas id="bubbleChart" height="140"></canvas>
    </div>
    <div class="card">
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç</h3>
      <div id="salaryIcons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px 0;"></div>
      <div id="salaryText"></div>
    </div>
  </div>
  <div class="card" style="margin-top:24px;">
    <h3>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</h3>
    <div id="horizontalBarChart" style="margin-top:16px;">
      <div id="barChartScale" style="position:relative; height:30px; margin-bottom:16px;">
        <div id="scaleLine" style="position:absolute; top:20px; left:0; right:0; height:1px; background:#d1d5db;"></div>
        <div id="scaleTicks" style="position:absolute; top:0; left:0; right:0; height:20px;">
          <!-- Tick marks will be dynamically generated here -->
        </div>
        <div id="scaleTickMarks" style="position:absolute; top:16px; left:0; right:0; height:8px;">
          <!-- Tick marks on the line will be dynamically generated here -->
        </div>
      </div>
      <div id="barChartContainer" style="display:flex; flex-direction:column; gap:8px;">
        <!-- Bars will be dynamically generated here -->
      </div>
    </div>
  </div>

  <div calss ="row" style="margin-top:24px;">
    <div class="card" id="resumesStackedCard" style="max-width: 700px; justify-self: left; width: 100%;">
      <h3>–†–µ–∑—é–º–µ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º</h3>
      <div id="resumesStackedMeta" class="meta" style="color:#000000; font-weight: 500;"></div>
      <canvas id="resumesStackedChart" height="400" style="margin-top:12px; width: 100%;"></canvas>
      <div id="resumesStackedLegend" class="meta" style="margin-top:8px;"></div>
    </div>
  </div>
  <script>
    function getParams() {
      const sp = new URLSearchParams(window.location.search);
      const query = sp.get('query') || 'python developer';
      const area = sp.get('area') || '2'; // Default to Saint-Petersburg
      const pages = parseInt(sp.get('pages')) || 2; // Default to 2 pages
      const per_page = parseInt(sp.get('per_page')) || 50; // Default to 50 per page
      return { query, area, pages, per_page };
    }

    function setControls({query}) {
      document.getElementById('q').value = query;
    }

    function applyFromControls() {
      const query = document.getElementById('q').value || 'python developer';
      const url = new URL(window.location.href);
      url.searchParams.set('query', query);
      url.searchParams.set('area', '2'); // Always use Saint-Petersburg
      window.location.href = url.toString();
    }

    // Build stacked chart for selected vacancies
    async function updateResumesStackedChart({ area, pages, per_page }) {
      const checkboxes = Array.from(document.querySelectorAll('.vacancyChoice'));
      const selected = checkboxes.filter(cb => cb.checked).map(cb => cb.value).slice(0, 4);
      const labelsMap = new Map([
        ['–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –∫–ø–ø', '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã-–∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä—ã'],
        ['–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –¥–æ—Å–º–æ—Ç—Ä', '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –ø–æ –¥–æ—Å–º–æ—Ç—Ä—É'],
        ['–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –ø–µ—Ä—Ä–æ–Ω', '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –ø–µ—Ä—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è'],
        ['–≥–±—Ä, –æ—Ö—Ä–∞–Ω–∞', '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä –ì–ë–†'],
      ]);

      const labels = selected.map(q => labelsMap.get(q) || q);

      // Fetch vacancy counts in parallel
      const fetchAnalyze = async (query) => {
        const url = new URL(window.location.origin + '/analyze');
        url.searchParams.set('query', query);
        url.searchParams.set('area', area);
        url.searchParams.set('pages', String(pages));
        url.searchParams.set('per_page', String(per_page));
        try {
          const res = await fetch(url);
          const data = await res.json();
          return typeof data.count === 'number' ? data.count : 0;
        } catch (e) {
          return 0;
        }
      };

      const vacancyCounts = await Promise.all(selected.map(fetchAnalyze));

      // Simple heuristic for resumes per vacancy and active share
      const SUPPLY_FACTOR = 1.5; // resumes per vacancy (approx)
      const ACTIVE_SHARE = 0.7;  // share of active resumes

      const totalResumes = vacancyCounts.map(c => Math.round(c * SUPPLY_FACTOR));
      const activeResumes = totalResumes.map(t => Math.round(t * ACTIVE_SHARE));
      const inactiveResumes = totalResumes.map((t, i) => Math.max(0, t - activeResumes[i]));
      const rpv = vacancyCounts.map((c, i) => (c > 0 ? (totalResumes[i] / c) : null));

      const meta = document.getElementById('resumesStackedMeta');
      meta.textContent = selected.length ? `–í—ã–±—Ä–∞–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: ${selected.length}` : '–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ 4 –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã';

      const ctx = document.getElementById('resumesStackedChart');
      const datasets = [
        {
          label: '–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—é–º–µ',
          data: activeResumes,
          backgroundColor: 'rgba(59, 130, 246, 0.7)',
          borderColor: 'rgb(59, 130, 246)',
          borderWidth: 1,
        },
        {
          label: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—é–º–µ',
          data: inactiveResumes,
          backgroundColor: 'rgba(203, 213, 225, 0.9)',
          borderColor: 'rgb(148, 163, 184)',
          borderWidth: 1,
        },
      ];

      if (window._resumesChart) {
        window._resumesChart.data.labels = labels;
        window._resumesChart.data.datasets = datasets;
        window._resumesChart.update();
      } else {
        window._resumesChart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: {
                callbacks: {
                  afterBody: (items) => {
                    if (!items || !items.length) return '';
                    const idx = items[0].dataIndex;
                    const val = rpv[idx];
                    return val ? `–†–µ–∑—é–º–µ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é: ${val.toFixed(2)}` : '–†–µ–∑—é–º–µ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é: N/A';
                  }
                }
              }
            },
            scales: {
              x: { stacked: true },
              y: { stacked: true, title: { display: true, text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—é–º–µ' } }
            }
          }
        });
      }

      // Legend with resumes_per_vacancy
      const legend = document.getElementById('resumesStackedLegend');
      legend.innerHTML = labels.map((lbl, i) => {
        const val = rpv[i];
        const cc = vacancyCounts[i] || 0;
        return `<div>${lbl}: –≤–∞–∫–∞–Ω—Å–∏–π ${cc}, R/V: ${typeof val === 'number' ? val.toFixed(2) : 'N/A'}</div>`;
      }).join('');
    }

    async function load() {
      const { query, area, pages, per_page } = getParams();
      setControls({ query });
      const url = new URL(window.location.origin + '/analyze');
      url.searchParams.set('query', query);
      url.searchParams.set('area', area);
      url.searchParams.set('pages', pages);
      url.searchParams.set('per_page', per_page);
      
      const analyzeStartTime = performance.now();
      const res = await fetch(url);
      const data = await res.json();
      const analyzeEndTime = performance.now();
      const analyzeLoadTime = Math.round(analyzeEndTime - analyzeStartTime);
      const s = data.salaries || {};
      const topSkills = Array.isArray(data.skills) ? data.skills.slice(0, 12) : [];
      // Display total vacancies found
      const vacancyStats = document.getElementById('vacancyStats');
      const totalVacancies = data.count || 0;
      vacancyStats.innerHTML = `üìä –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: ${totalVacancies.toLocaleString()}`;
      
      // Create salary stat icons instead of bar chart
      const salaryIcons = document.getElementById('salaryIcons');
      salaryIcons.innerHTML = '';
      
      const stats = [
        { label: '–ú–∏–Ω', value: s.min, icon: 'üìâ', color: '#60a5fa' },
        { label: '–ú–µ–¥–∏–∞–Ω–∞', value: s.median, icon: 'üìä', color: '#60a5fa' },
        { label: '–°—Ä–µ–¥–Ω—è—è', value: s.avg, icon: 'üìà', color: '#60a5fa' },
        { label: '–ú–∞–∫—Å', value: s.max, icon: 'üöÄ', color: '#60a5fa' }
      ];
      
      stats.forEach(stat => {
        const iconDiv = document.createElement('div');
        iconDiv.style.cssText = `
          text-align: center;
          padding: 12px;
          border-radius: 8px;
          background: linear-gradient(135deg, ${stat.color}20, ${stat.color}10);
          border: 1px solid ${stat.color}30;
        `;
        iconDiv.innerHTML = `
          <div style="font-size: 24px; margin-bottom: 4px;">${stat.icon}</div>
          <div style="font-weight: bold; color: ${stat.color}; font-size: 14px;">${stat.label}</div>
          <div style="font-size: 16px; font-weight: bold; margin-top: 4px;">
            ${stat.value ? Math.round(stat.value).toLocaleString() + '‚ÇΩ' : 'N/A'}
          </div>
        `;
        salaryIcons.appendChild(iconDiv);
      });
      


      // Bubble chart: fetch simplified items including employer marks
      const fUrl = new URL(window.location.origin + '/fetch');
      fUrl.searchParams.set('query', query);
      if (area) fUrl.searchParams.set('area', area);
      if (pages !== null) fUrl.searchParams.set('pages', String(pages));
      fUrl.searchParams.set('per_page', String(per_page));
      fUrl.searchParams.set('simplified', 'true');
      fUrl.searchParams.set('employer_mark', 'true');
      
      const bubbleStartTime = performance.now();
      const fres = await fetch(fUrl);
      const fdata = await fres.json();
      const bubbleEndTime = performance.now();
      const bubbleLoadTime = Math.round(bubbleEndTime - bubbleStartTime);
      const items = Array.isArray(fdata.items) ? fdata.items : [];
      console.log('Bubble chart data:', { itemsCount: items.length, sampleItem: items[0] });
      // Build salaries array (exclude per-shift)
      const salaries = items.map(v => {
        if (v.salary_per_shift === true) return null;
        if (typeof v.salary_avg === 'number') return v.salary_avg;
        if (v.salary && typeof v.salary === 'object') {
          const sf = (typeof v.salary.from === 'number') ? v.salary.from : null;
          const st = (typeof v.salary.to === 'number') ? v.salary.to : null;
          if (sf !== null && st !== null) return (sf + st) / 2;
          if (sf !== null) return sf;
          if (st !== null) return st;
        }
        return null;
      }).filter(x => typeof x === 'number' && x >= 10000).sort((a,b) => a-b);

      // Percentile helper
      const percentile = (arr, p) => {
        if (!arr.length) return null;
        const idx = (arr.length - 1) * p;
        const lo = Math.floor(idx);
        const hi = Math.ceil(idx);
        if (lo === hi) return arr[lo];
        const w = idx - lo;
        return arr[lo] * (1 - w) + arr[hi] * w;
      };

      const p25 = percentile(salaries, 0.25);
      const p50 = percentile(salaries, 0.50);
      const p75 = percentile(salaries, 0.75);
      const sMax = salaries.length ? salaries[salaries.length - 1] : null;
      const sAvg = salaries.length ? (salaries.reduce((a,b)=>a+b,0) / salaries.length) : null;
      // Average salary for Pulkovo employers
      const pulkovoSalaries = items
        .filter(v => ((v.employer_name || '').toLowerCase().includes('–ø—É–ª–∫–æ–≤–æ') || (v.employer_name || '').toLowerCase().includes('–≤–æ–∑–¥—É—à–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞')) && v.salary_per_shift !== true)
        .map(v => {
          if (typeof v.salary_avg === 'number') return v.salary_avg;
          if (v.salary && typeof v.salary === 'object') {
            const sf = (typeof v.salary.from === 'number') ? v.salary.from : null;
            const st = (typeof v.salary.to === 'number') ? v.salary.to : null;
            if (sf !== null && st !== null) return (sf + st) / 2;
            if (sf !== null) return sf;
            if (st !== null) return st;
          }
          return null;
        })
        .filter(x => typeof x === 'number');
      const pulkovoAvg = pulkovoSalaries.length ? (pulkovoSalaries.reduce((a,b)=>a+b,0) / pulkovoSalaries.length) : null;

      // Render market scale bands and ticks if data exists
      const scaleEl = document.getElementById('marketScale');
      if (p25 && p50 && p75 && sMax) {
        const minBase = salaries[0];
        const span = sMax - minBase || 1;
        const toPct = (v) => `${Math.max(0, Math.min(100, ((v - minBase) / span) * 100))}%`;
        document.getElementById('bandBelow').style.width = toPct(p25);
        document.getElementById('bandIn').style.left = toPct(p25);
        document.getElementById('bandIn').style.width = `calc(${toPct(p75)} - ${toPct(p25)})`;
        document.getElementById('bandAbove').style.left = toPct(p75);
        document.getElementById('bandAbove').style.width = `calc(100% - ${toPct(p75)})`;

        // Place Pulkovo salary marker
        const pulkovoMarker = document.getElementById('markerPulkovoLine');
        const pulkovoLabel = document.getElementById('markerPulkovoLabel');
        if (pulkovoAvg) {
          pulkovoMarker.style.left = toPct(pulkovoAvg);
          pulkovoMarker.style.display = 'block';
          pulkovoLabel.style.left = toPct(pulkovoAvg);
          pulkovoLabel.innerText = `–ü—É–ª–∫–æ–≤–æ: ${Math.round(pulkovoAvg).toLocaleString()}‚ÇΩ`;
          pulkovoLabel.style.display = 'block';
        } else {
          pulkovoMarker.style.display = 'none';
          pulkovoLabel.style.display = 'none';
        }

        document.getElementById('valP25').innerText = Math.round(p25).toLocaleString();
        document.getElementById('valP50').innerText = Math.round(p50).toLocaleString();
        document.getElementById('valP75').innerText = Math.round(p75).toLocaleString();
        document.getElementById('valMax').innerText = Math.round(sMax).toLocaleString();
      } else {
        scaleEl.innerHTML = '<div style="padding:8px; color:#6b7280;">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</div>';
      }

      const points = items
        .map(v => {
          let x = typeof v.salary_avg === 'number' ? v.salary_avg : null;
          // Exclude per-shift salaries entirely from bubble chart
          if (v.salary_per_shift === true) {
            x = null;
          }
          if (x === null && v.salary && typeof v.salary === 'object') {
            const sf = (typeof v.salary.from === 'number') ? v.salary.from : null;
            const st = (typeof v.salary.to === 'number') ? v.salary.to : null;
            if (sf !== null && st !== null) x = (sf + st) / 2;
            else if (sf !== null) x = sf;
            else if (st !== null) x = st;
          }
          // Prefer employer_mark; if missing, fallback to employer_trusted as 1/0
          let y = null;
          if (typeof v.employer_mark === 'number') {
            y = v.employer_mark;
          } else if (typeof v.employer_trusted === 'boolean') {
            y = v.employer_trusted ? 1 : 0;
          }
          const isPulkovo = (v.employer_name || '').toLowerCase().includes('–ø—É–ª–∫–æ–≤–æ') || 
                           (v.employer_name || '').toLowerCase().includes('–≤–æ–∑–¥—É—à–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞');
          
          return {
            x,
            y,
            r: isPulkovo ? 12 : 6, // Larger bubble for Pulkovo
            title: v.title || '',
            employer: v.employer_name || '',
            isPulkovo: isPulkovo
          };
        })
        .filter(p => p.x !== null && p.y !== null);
      console.log('Bubble chart points:', { pointsCount: points.length, samplePoints: points.slice(0, 3) });
      // Create horizontal bar chart for candidate requirements
      const barChartContainer = document.getElementById('barChartContainer');
      if (barChartContainer) {
        barChartContainer.innerHTML = '';
        
        // Combine skills and experience data for the bar chart
        const chartData = [];
        
        // Add top skills
        topSkills.slice(0, 5).forEach((skill, index) => {
          const count = skillCounts.get(skill) || 0;
          chartData.push({
            label: skill,
            value: count,
            type: 'skill'
          });
        });
        
        // Add experience data
        const expCounts = new Map();
        items.forEach(v => {
          const e = (v.experience || '').toString().trim();
          if (!e) return;
          expCounts.set(e, (expCounts.get(e) || 0) + 1);
        });
        const expEntries = Array.from(expCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 3);
        expEntries.forEach(([label, count]) => {
          chartData.push({
            label: label,
            value: count,
            type: 'experience'
          });
        });
        
        // Sort by value and take top 5
        const sortedData = chartData.sort((a, b) => b.value - a.value).slice(0, 5);
        const maxValue = Math.max(...sortedData.map(d => d.value));
        
        // Create scale with tick marks (like in the image)
        const scaleTicks = document.getElementById('scaleTicks');
        const scaleTickMarks = document.getElementById('scaleTickMarks');
        
        if (scaleTicks && scaleTickMarks) {
          scaleTicks.innerHTML = '';
          scaleTickMarks.innerHTML = '';
          
          // Create tick marks at intervals of 10, 20, 30, etc. up to maxValue
          const tickInterval = Math.ceil(maxValue / 6); // Create about 6 tick marks
          const roundedInterval = Math.ceil(tickInterval / 10) * 10; // Round to nearest 10
          
          for (let i = 0; i <= maxValue; i += roundedInterval) {
            const percentage = (i / maxValue) * 100;
            
            // Create number labels above
            const tickLabel = document.createElement('div');
            tickLabel.textContent = i;
            tickLabel.style.cssText = `position: absolute; left: ${percentage}%; transform: translateX(-50%); font-size: 12px; color: #6b7280; text-align: center; white-space: nowrap; line-height: 1;`;
            scaleTicks.appendChild(tickLabel);
            
            // Create tick marks on the line
            const tickMark = document.createElement('div');
            tickMark.style.cssText = `position: absolute; left: ${percentage}%; transform: translateX(-50%); width: 1px; height: 8px; background: #9ca3af;`;
            scaleTickMarks.appendChild(tickMark);
          }
        }
        
        sortedData.forEach((item, index) => {
          const percentage = (item.value / maxValue) * 100;
          
          const barContainer = document.createElement('div');
          barContainer.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 8px;';
          
          const label = document.createElement('div');
          label.textContent = item.label;
          label.style.cssText = 'min-width: 120px; font-size: 14px; color: #374151; font-weight: 500;';
          
          const barWrapper = document.createElement('div');
          barWrapper.style.cssText = 'flex: 1; position: relative; height: 24px; background: #f3f4f6; border-radius: 0; overflow: visible;';
          
          const bar = document.createElement('div');
          bar.style.cssText = `height: 100%; width: ${percentage}%; background: #93c5fd; border-radius: 0; transition: width 0.3s ease; position: relative;`;
          
          // Add value label at the end of the bar (inside the bar)
          const valueLabel = document.createElement('div');
          valueLabel.textContent = item.value;
          valueLabel.style.cssText = 'position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 12px; color: white; font-weight: 600; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);';
          
          bar.appendChild(valueLabel);
          barWrapper.appendChild(bar);
          barContainer.appendChild(label);
          barContainer.appendChild(barWrapper);
          barChartContainer.appendChild(barContainer);
        });
      }
      const bubbleCtx = document.getElementById('bubbleChart');
      // Separate Pulkovo and other companies
      const pulkovoPoints = points.filter(p => p.isPulkovo);
      const otherPoints = points.filter(p => !p.isPulkovo);
      
      new Chart(bubbleCtx, {
        type: 'bubble',
        data: { 
          datasets: [
            {
              label: '–î—Ä—É–≥–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏',
              data: otherPoints,
              backgroundColor: 'rgba(59, 130, 246, 0.6)',
              borderColor: 'rgb(59, 130, 246)'
            },
            {
              label: '–ê—ç—Ä–æ–ø–æ—Ä—Ç –ü—É–ª–∫–æ–≤–æ',
              data: pulkovoPoints,
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderColor: 'rgb(239, 68, 68)'
            }
          ]
        },
        options: {
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw;
                  return `${v.employer} ‚Äì ${v.title}: –∑–∞—Ä–ø–ª–∞—Ç–∞ ${Math.round(v.x)} | —Ä–µ–π—Ç–∏–Ω–≥ ${v.y.toFixed(1)}`;
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: '–ó–∞—Ä–ø–ª–∞—Ç–∞ (—Ä—É–±.)' } },
            y: { title: { display: true, text: '–†–µ–π—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è (1-5)' }, min: 1, max: 5 }
          }
        }
      });

      
      // Build initial stacked resumes chart
      await updateResumesStackedChart({ area, pages, per_page });
    }

    document.getElementById('apply').addEventListener('click', applyFromControls);
    document.getElementById('applyStacked').addEventListener('click', async () => {
      const { area, pages, per_page } = getParams();
      await updateResumesStackedChart({ area, pages, per_page });
    });
    
    // Handle preset dropdown with defensive mapping
    document.getElementById('presets').addEventListener('change', (e) => {
      const raw = e.target.value || '';
      const text = e.target.options[e.target.selectedIndex]?.text || '';
      const norm = (s) => (s || '').toString().trim().toLowerCase();
      const presetMap = new Map([
        ['–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä—ã –≥–±—Ä', '–≥–±—Ä, –æ—Ö—Ä–∞–Ω–∞'],
        ['–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –≥–±—Ä', '–≥–±—Ä, –æ—Ö—Ä–∞–Ω–∞'],
      ]);
      const mapped = presetMap.get(norm(text)) || presetMap.get(norm(raw)) || raw;
      if (mapped) {
        document.getElementById('q').value = mapped;
        applyFromControls();
      }
    });
    
    load();
  </script>
</body>
</html>